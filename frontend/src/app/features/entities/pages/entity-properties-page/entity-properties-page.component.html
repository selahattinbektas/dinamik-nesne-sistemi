<section class="card">
  <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
    <div>
      <h2 class="section-title">Entity - Property Yönetimi</h2>
      <p style="margin: 4px 0 0; color: #6b7280;">
        Entity: <strong>{{ entity?.id || '-' }}</strong> | Metadata: <strong>{{ metaDataName || '-' }}</strong>
      </p>
    </div>
    <button type="button" class="secondary" (click)="goBack()">Geri</button>
  </div>

  <form [formGroup]="propertiesForm" (ngSubmit)="submitProperties()" style="margin-top: 24px;">
    <div *ngIf="availablePropertyItems.length; else noAvailableProperties" class="form-grid">
      <ng-container *ngFor="let item of availablePropertyItems">
        <ng-container [ngSwitch]="item.type">
          <label class="form-field" *ngSwitchCase="'TEXT'">
            {{ item.title }}
            <input type="text" [formControlName]="getPropertyKey(item)" />
          </label>
          <label class="form-field" *ngSwitchCase="'TEXTAREA'">
            {{ item.title }}
            <textarea rows="3" [formControlName]="getPropertyKey(item)"></textarea>
          </label>
          <label class="form-field" *ngSwitchCase="'NUMBER'">
            {{ item.title }}
            <input type="number" [formControlName]="getPropertyKey(item)" />
          </label>
          <label class="form-field" *ngSwitchCase="'DATE'">
            {{ item.title }}
            <input type="date" [formControlName]="getPropertyKey(item)" />
          </label>
          <label class="form-field" *ngSwitchCase="'SELECT'">
            {{ item.title }}
            <select [formControlName]="getPropertyKey(item)">
              <option *ngFor="let option of item.options" [value]="option.value">{{ option.label }}</option>
            </select>
          </label>
          <div class="form-field" *ngSwitchCase="'RADIO'">
            <span>{{ item.title }}</span>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px;">
              <label *ngFor="let option of item.options" style="display: flex; align-items: center; gap: 6px;">
                <input type="radio" [formControlName]="getPropertyKey(item)" [value]="option.value" />
                {{ option.label }}
              </label>
            </div>
          </div>
          <label class="form-field" *ngSwitchCase="'CHECKBOX'" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" [formControlName]="getPropertyKey(item)" />
            {{ item.title }}
          </label>
        </ng-container>
      </ng-container>
    </div>

    <ng-template #noAvailableProperties>
      <p style="margin: 0; color: #6b7280;">Eklenebilir property bulunmuyor.</p>
    </ng-template>

    <div style="margin-top: 16px; display: flex; gap: 12px;">
      <button type="submit" [disabled]="isLoading || !availablePropertyItems.length">Kaydet</button>
    </div>
  </form>

  <p *ngIf="errorMessage" style="margin-top: 12px; color: #dc2626;">{{ errorMessage }}</p>
  <p *ngIf="isLoading" style="margin-top: 12px;">Yükleniyor...</p>

  <table class="table" *ngIf="assignedProperties.length">
    <thead>
      <tr>
        <th>Property</th>
        <th>Type</th>
        <th>Value</th>
        <th>İşlemler</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of assignedProperties">
        <td>{{ item.item.title }}</td>
        <td><span class="badge">{{ item.item.type }}</span></td>
        <td><pre style="margin: 0; white-space: pre-wrap;">{{ item.value | json }}</pre></td>
        <td>
          <div class="table-actions">
            <button type="button" class="secondary" (click)="openEditDialog(item.item, item.value)" [disabled]="isLoading">
              Güncelle
            </button>
            <button type="button" class="danger" (click)="deleteProperty(item.item)" [disabled]="isLoading">
              Sil
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <app-empty-state
    *ngIf="!assignedProperties.length && !isLoading"
    message="Henüz eklenmiş property yok."
  ></app-empty-state>
</section>

<div class="modal-backdrop" *ngIf="isEditDialogOpen">
  <div class="modal">
    <h3 class="modal-title">Property Güncelle</h3>
    <form [formGroup]="editForm" (ngSubmit)="updateProperty()">
      <div class="form-grid">
        <ng-container [ngSwitch]="editPropertyItem?.type">
          <label class="form-field" *ngSwitchCase="'TEXT'">
            Değer
            <input type="text" formControlName="value" />
          </label>
          <label class="form-field" *ngSwitchCase="'TEXTAREA'">
            Değer
            <textarea rows="3" formControlName="value"></textarea>
          </label>
          <label class="form-field" *ngSwitchCase="'NUMBER'">
            Değer
            <input type="number" formControlName="value" />
          </label>
          <label class="form-field" *ngSwitchCase="'DATE'">
            Değer
            <input type="date" formControlName="value" />
          </label>
          <label class="form-field" *ngSwitchCase="'SELECT'">
            Değer
            <select formControlName="value">
              <option *ngFor="let option of editPropertyItem?.options" [value]="option.value">{{ option.label }}</option>
            </select>
          </label>
          <div class="form-field" *ngSwitchCase="'RADIO'">
            <span>Değer</span>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px;">
              <label *ngFor="let option of editPropertyItem?.options" style="display: flex; align-items: center; gap: 6px;">
                <input type="radio" formControlName="value" [value]="option.value" />
                {{ option.label }}
              </label>
            </div>
          </div>
          <label class="form-field" *ngSwitchCase="'CHECKBOX'" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" formControlName="value" />
            Değer
          </label>
          <label class="form-field" *ngSwitchDefault>
            Değer
            <input type="text" formControlName="value" />
          </label>
        </ng-container>
      </div>

      <div class="modal-actions">
        <button type="button" class="secondary" (click)="closeEditDialog()">Vazgeç</button>
        <button type="submit" [disabled]="isLoading">Kaydet</button>
      </div>
    </form>
  </div>
</div>
